---
# Deploy ROS2 applications with multi-domain DDS support
# Matches terraform+kustomize approach from apps/base
# Usage: ansible-playbook playbooks/deploy-ros2.yml

- name: Deploy ROS2 Applications
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default(ansible_env.KUBECONFIG, true) }}"
    # ROS2 apps configuration
    ros_version: "humble"
    ros_image: "arm64v8/ros:{{ ros_version }}"
    fastdds_image: "osrf/ros:{{ ros_version }}-desktop"
    default_namespace: "default"
  
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  
  tasks:
    - name: Check kubectl is available
      shell: kubectl version --client
      changed_when: false
    
    - name: Create namespace for ROS2 apps
      kubernetes.core.k8s:
        name: "{{ default_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
    
    - name: Deploy FastDDS Discovery Server (Domain 42)
      kubernetes.core.k8s:
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: fastdds-discovery-server
            namespace: "{{ default_namespace }}"
            labels:
              app: fastdds-discovery-server
              ros-domain: "42"
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: fastdds-discovery-server
            template:
              metadata:
                labels:
                  app: fastdds-discovery-server
                  ros-domain: "42"
              spec:
                containers:
                - name: discovery-server
                  image: "{{ fastdds_image }}"
                  imagePullPolicy: IfNotPresent
                  command:
                  - /bin/bash
                  - -c
                  - |
                    apt-get update && apt-get install -y fastdds-tools >/dev/null 2>&1
                    fastdds discovery --server-id 0 --listen-address 0.0.0.0 --port 11811
                  env:
                  - name: ROS_DOMAIN_ID
                    value: "42"
                  ports:
                  - containerPort: 11811
                    name: discovery
                    protocol: TCP
                  resources:
                    requests:
                      cpu: 100m
                      memory: 128Mi
                    limits:
                      cpu: 500m
                      memory: 512Mi
                  livenessProbe:
                    exec:
                      command:
                      - /bin/bash
                      - -c
                      - "netstat -tuln | grep 11811"
                    initialDelaySeconds: 10
                    periodSeconds: 10
        state: present
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
    
    - name: Create FastDDS Discovery Server Service
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: fastdds-discovery-server
            namespace: "{{ default_namespace }}"
            labels:
              app: fastdds-discovery-server
              ros-domain: "42"
          spec:
            type: ClusterIP
            selector:
              app: fastdds-discovery-server
            ports:
            - name: discovery
              port: 11811
              protocol: TCP
              targetPort: 11811
        state: present
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
    
    - name: Deploy ROS2 Talker (Domain 42, Cloud)
      kubernetes.core.k8s:
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ros2-talker-cloud
            namespace: "{{ default_namespace }}"
            labels:
              app: ros2-talker
              component: talker
              ros-domain: "42"
              location: cloud
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ros2-talker
                component: talker
            template:
              metadata:
                labels:
                  app: ros2-talker
                  component: talker
                  ros-domain: "42"
                  location: cloud
              spec:
                containers:
                - name: talker
                  image: "{{ ros_image }}"
                  imagePullPolicy: IfNotPresent
                  command:
                  - /bin/bash
                  - -c
                  - |
                    source /opt/ros/{{ ros_version }}/setup.bash
                    ros2 run demo_nodes_cpp talker
                  env:
                  - name: ROS_DOMAIN_ID
                    value: "42"
                  - name: ROS_LOCALHOST_ONLY
                    value: "0"
                  - name: FASTDDS_DISCOVERY_SERVER
                    value: "fastdds-discovery-server:11811"
                  resources:
                    requests:
                      cpu: 200m
                      memory: 256Mi
                    limits:
                      cpu: 1000m
                      memory: 1Gi
                  livenessProbe:
                    exec:
                      command:
                      - /bin/bash
                      - -c
                      - "pgrep -f 'talker' || exit 1"
                    initialDelaySeconds: 10
                    periodSeconds: 10
        state: present
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
    
    - name: Deploy ROS2 Listener (Domain 42, Cloud)
      kubernetes.core.k8s:
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ros2-listener-cloud
            namespace: "{{ default_namespace }}"
            labels:
              app: ros2-listener
              component: listener
              ros-domain: "42"
              location: cloud
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ros2-listener
                component: listener
            template:
              metadata:
                labels:
                  app: ros2-listener
                  component: listener
                  ros-domain: "42"
                  location: cloud
              spec:
                containers:
                - name: listener
                  image: "{{ ros_image }}"
                  imagePullPolicy: IfNotPresent
                  command:
                  - /bin/bash
                  - -c
                  - |
                    source /opt/ros/{{ ros_version }}/setup.bash
                    ros2 run demo_nodes_cpp listener
                  env:
                  - name: ROS_DOMAIN_ID
                    value: "42"
                  - name: ROS_LOCALHOST_ONLY
                    value: "0"
                  - name: FASTDDS_DISCOVERY_SERVER
                    value: "fastdds-discovery-server:11811"
                  resources:
                    requests:
                      cpu: 200m
                      memory: 256Mi
                    limits:
                      cpu: 1000m
                      memory: 1Gi
                  livenessProbe:
                    exec:
                      command:
                      - /bin/bash
                      - -c
                      - "pgrep -f 'listener' || exit 1"
                    initialDelaySeconds: 10
                    periodSeconds: 10
        state: present
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
    
    - name: Deploy IoT Sensor App (Domain 43 - Isolated)
      kubernetes.core.k8s:
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: iot-sensor-node
            namespace: "{{ default_namespace }}"
            labels:
              app: iot-sensor
              ros-domain: "43"
              location: cloud
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: iot-sensor
            template:
              metadata:
                labels:
                  app: iot-sensor
                  ros-domain: "43"
                  location: cloud
              spec:
                containers:
                - name: sensor
                  image: "{{ ros_image }}"
                  imagePullPolicy: IfNotPresent
                  command:
                  - /bin/bash
                  - -c
                  - |
                    source /opt/ros/{{ ros_version }}/setup.bash
                    # Dummy sensor node on separate domain
                    ros2 run demo_nodes_cpp talker --ros-args --remap __node:=sensor_pub
                  env:
                  - name: ROS_DOMAIN_ID
                    value: "43"
                  - name: ROS_LOCALHOST_ONLY
                    value: "0"
                  resources:
                    requests:
                      cpu: 100m
                      memory: 128Mi
                    limits:
                      cpu: 500m
                      memory: 512Mi
        state: present
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
    
    - name: Wait for ROS2 talker deployment
      shell: |
        kubectl rollout status deployment/ros2-talker-cloud -n {{ default_namespace }} --timeout=120s
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: talker_status
      changed_when: false
      ignore_errors: yes
    
    - name: Wait for ROS2 listener deployment
      shell: |
        kubectl rollout status deployment/ros2-listener-cloud -n {{ default_namespace }} --timeout=120s
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: listener_status
      changed_when: false
      ignore_errors: yes
    
    - name: Get ROS2 deployment status
      shell: |
        kubectl get deployments -n {{ default_namespace }} -l ros-domain=42 -o wide
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: ros2_deploy_status
      changed_when: false
    
    - name: Display ROS2 deployments
      debug:
        msg: "{{ ros2_deploy_status.stdout_lines }}"
    
    - name: Get ROS2 pods
      shell: |
        kubectl get pods -n {{ default_namespace }} -l ros-domain -o wide
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: ros2_pods
      changed_when: false
    
    - name: Display ROS2 pods
      debug:
        msg: "{{ ros2_pods.stdout_lines }}"
    
    - name: Summary
      debug:
        msg: |
          ROS2 Applications deployed successfully!
          
          Deployments:
          - fastdds-discovery-server (Domain 42)
          - ros2-talker-cloud (Domain 42 - Cloud)
          - ros2-listener-cloud (Domain 42 - Cloud)
          - iot-sensor-node (Domain 43 - Isolated)
          
          Multi-Domain Isolation:
          Domain 42: Talker + Listener + Discovery Server (communicate with each other)
          Domain 43: IoT Sensor (ISOLATED from Domain 42)
          
          View logs:
            kubectl logs -f deployment/ros2-talker-cloud
            kubectl logs -f deployment/ros2-listener-cloud
            kubectl logs -f deployment/iot-sensor-node
          
          Verify communication:
            kubectl exec -it <talker-pod> -- ros2 topic list
            kubectl exec -it <listener-pod> -- ros2 topic echo /chatter
          
          Monitor pods:
            kubectl get pods -n {{ default_namespace }} -l ros-domain=42 -w
